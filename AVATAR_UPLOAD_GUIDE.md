# å¤´åƒä¸Šä¼ åŠŸèƒ½ä½¿ç”¨æŒ‡å—

## âœ… å·²å®ç°çš„åŠŸèƒ½

æˆåŠŸæ·»åŠ äº†å®Œæ•´çš„å¤´åƒä¸Šä¼ å’Œæ˜¾ç¤ºåŠŸèƒ½ï¼š
- å¤´åƒä¸Šä¼ ï¼ˆæ”¯æŒjpgã€pngã€gifã€webpï¼Œæœ€å¤§5MBï¼‰
- å¤´åƒé¢„è§ˆ
- ä»æ•°æ®åº“è·å–å¹¶æ˜¾ç¤ºå¤´åƒ
- å¤´åƒåœ¨æ‰€æœ‰é¡µé¢åŒæ­¥æ˜¾ç¤º

## ğŸ“ æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶

### åç«¯æ–‡ä»¶

```
BuildMaster-API/
â”œâ”€â”€ src/main/java/com/buildmaster/
â”‚   â”œâ”€â”€ controller/
â”‚   â”‚   â”œâ”€â”€ FileController.java          # â­æ–°å¢ - æ–‡ä»¶ä¸Šä¼ ä¸‹è½½æ§åˆ¶å™¨
â”‚   â”‚   â””â”€â”€ UserController.java          # â­æ›´æ–° - æ·»åŠ æ›´æ–°ç”¨æˆ·ä¿¡æ¯å’Œä¿®æ”¹å¯†ç æ¥å£
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â””â”€â”€ UserService.java             # â­æ›´æ–° - æ·»åŠ æ›´æ–°ç”¨æˆ·ä¿¡æ¯å’Œä¿®æ”¹å¯†ç æ–¹æ³•
â”‚   â””â”€â”€ dto/
â”‚       â””â”€â”€ LoginResponse.java           # â­æ›´æ–° - æ·»åŠ avatarUrlå­—æ®µ
â””â”€â”€ src/main/resources/
    â””â”€â”€ application.yml                  # â­æ›´æ–° - æ·»åŠ æ–‡ä»¶ä¸Šä¼ é…ç½®
```

### å‰ç«¯æ–‡ä»¶

```
BuildMaster-UI/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â””â”€â”€ profile/
â”‚   â”‚       â””â”€â”€ page.tsx                 # â­æ›´æ–° - æ·»åŠ å¤´åƒä¸Šä¼ åŠŸèƒ½
â”‚   â””â”€â”€ components/
â”‚       â””â”€â”€ UserMenu.tsx                 # â­æ›´æ–° - æ˜¾ç¤ºçœŸå®å¤´åƒ
```

## ğŸ¨ åŠŸèƒ½ç‰¹æ€§

### 1. å¤´åƒä¸Šä¼ 

**ä½ç½®ï¼š** ä¸ªäººä¸­å¿ƒé¡µé¢ï¼ˆ`/profile`ï¼‰

**åŠŸèƒ½ï¼š**
- ç‚¹å‡»å¤´åƒå¯ä¸Šä¼ æ–°å¤´åƒ
- æ”¯æŒæ ¼å¼ï¼šjpgã€jpegã€pngã€gifã€webp
- æœ€å¤§æ–‡ä»¶å¤§å°ï¼š5MB
- å®æ—¶é¢„è§ˆ
- ä¸Šä¼ è¿›åº¦æç¤º

**æµç¨‹ï¼š**
1. ç”¨æˆ·ç‚¹å‡»å¤´åƒ
2. é€‰æ‹©å›¾ç‰‡æ–‡ä»¶
3. å‰ç«¯æ˜¾ç¤ºé¢„è§ˆ
4. è‡ªåŠ¨ä¸Šä¼ åˆ°æœåŠ¡å™¨
5. æœåŠ¡å™¨è¿”å›å›¾ç‰‡URL
6. æ›´æ–°ç”¨æˆ·ä¿¡æ¯åˆ°æ•°æ®åº“
7. å…¨å±€å¤´åƒåŒæ­¥æ›´æ–°

### 2. å¤´åƒæ˜¾ç¤º

**æ˜¾ç¤ºä½ç½®ï¼š**
- å³ä¸Šè§’ç”¨æˆ·èœå•
- ä¸ªäººä¸­å¿ƒé¡µé¢
- ä¸‹æ‹‰èœå•ä¸­

**æ˜¾ç¤ºé€»è¾‘ï¼š**
- å¦‚æœæœ‰å¤´åƒï¼šæ˜¾ç¤ºå¤´åƒå›¾ç‰‡
- å¦‚æœæ²¡æœ‰å¤´åƒï¼šæ˜¾ç¤ºé¦–å­—æ¯ï¼ˆæ¸å˜è‰²èƒŒæ™¯ï¼‰

### 3. å¤´åƒå­˜å‚¨

**å­˜å‚¨è·¯å¾„ï¼š** `uploads/avatars/`

**æ–‡ä»¶å‘½åï¼š** UUID + åŸå§‹æ‰©å±•åï¼ˆå¦‚ï¼š`a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg`ï¼‰

**æ•°æ®åº“ï¼š** `users.avatar_url` å­—æ®µå­˜å‚¨ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚ï¼š`/api/files/avatars/xxx.jpg`ï¼‰

## ğŸš€ ä½¿ç”¨æ­¥éª¤

### 1. å¯åŠ¨åç«¯

```bash
cd BuildMaster-API
mvn spring-boot:run
```

### 2. å¯åŠ¨å‰ç«¯

```bash
cd BuildMaster-UI
npm run dev
```

### 3. ç™»å½•ç³»ç»Ÿ

è®¿é—® http://localhost:3000/login

### 4. è¿›å…¥ä¸ªäººä¸­å¿ƒ

ç‚¹å‡»å³ä¸Šè§’ç”¨æˆ·èœå• â†’ ä¸ªäººä¿¡æ¯

### 5. ä¸Šä¼ å¤´åƒ

1. é¼ æ ‡æ‚¬åœåœ¨å¤´åƒä¸Šï¼Œä¼šæ˜¾ç¤º"æ›´æ¢å¤´åƒ"æç¤º
2. ç‚¹å‡»å¤´åƒ
3. é€‰æ‹©å›¾ç‰‡æ–‡ä»¶
4. ç­‰å¾…ä¸Šä¼ å®Œæˆ
5. å¤´åƒè‡ªåŠ¨æ›´æ–°

## ğŸ“ APIæ¥å£è¯´æ˜

### 1. ä¸Šä¼ å¤´åƒ

```http
POST /api/files/upload/avatar
Content-Type: multipart/form-data

file: [å›¾ç‰‡æ–‡ä»¶]
```

**å“åº”ï¼š**
```json
{
  "success": true,
  "message": "å¤´åƒä¸Šä¼ æˆåŠŸ",
  "url": "/api/files/avatars/uuid-filename.jpg",
  "filename": "uuid-filename.jpg"
}
```

### 2. è·å–å¤´åƒ

```http
GET /api/files/avatars/{filename}
```

**å“åº”ï¼š** å›¾ç‰‡äºŒè¿›åˆ¶æ•°æ®

### 3. æ›´æ–°ç”¨æˆ·ä¿¡æ¯

```http
PUT /api/user/update?userId={userId}&username={username}&displayName={displayName}&avatarUrl={avatarUrl}
```

**å“åº”ï¼š**
```json
{
  "success": true,
  "message": "æ›´æ–°æˆåŠŸ",
  "data": {
    "id": 1,
    "username": "testuser",
    "email": "test@example.com",
    "displayName": "æµ‹è¯•ç”¨æˆ·",
    "avatarUrl": "/api/files/avatars/xxx.jpg",
    "createdAt": "2025-10-21T10:00:00"
  }
}
```

### 4. ä¿®æ”¹å¯†ç 

```http
PUT /api/user/change-password?userId={userId}&currentPassword={currentPassword}&newPassword={newPassword}
```

**å“åº”ï¼š**
```json
{
  "success": true,
  "message": "å¯†ç ä¿®æ”¹æˆåŠŸ",
  "data": null
}
```

## ğŸ’» å‰ç«¯ä»£ç ç¤ºä¾‹

### å¤´åƒä¸Šä¼ å¤„ç†

```typescript
const handleAvatarUpload = async (file: File) => {
  setUploadingAvatar(true);
  
  try {
    const formData = new FormData();
    formData.append('file', file);

    const response = await fetch('http://localhost:8080/api/files/upload/avatar', {
      method: 'POST',
      body: formData,
    });

    const result = await response.json();

    if (result.success) {
      const newAvatarUrl = `http://localhost:8080${result.url}`;
      setAvatarUrl(newAvatarUrl);
      
      // æ›´æ–°åˆ°æ•°æ®åº“
      await updateUserAvatar(result.url);
      
      setSuccess('å¤´åƒä¸Šä¼ æˆåŠŸï¼');
    }
  } catch (err) {
    setError('å¤´åƒä¸Šä¼ å¤±è´¥');
  } finally {
    setUploadingAvatar(false);
  }
};
```

### æ˜¾ç¤ºå¤´åƒ

```typescript
// åœ¨UserMenuç»„ä»¶ä¸­
<div className="w-8 h-8 rounded-full bg-gradient-to-r from-cyan-500 to-blue-600 flex items-center justify-center text-white font-bold overflow-hidden">
  {user.avatarUrl ? (
    <img 
      src={user.avatarUrl.startsWith('http') ? user.avatarUrl : `http://localhost:8080${user.avatarUrl}`} 
      alt="Avatar" 
      className="w-full h-full object-cover"
    />
  ) : (
    user.displayName?.charAt(0).toUpperCase() || 'U'
  )}
</div>
```

## ğŸ”§ é…ç½®è¯´æ˜

### application.yml

```yaml
# æ–‡ä»¶ä¸Šä¼ é…ç½®
file:
  upload:
    path: uploads/avatars

spring:
  servlet:
    multipart:
      max-file-size: 5MB
      max-request-size: 5MB
```

### åç«¯éªŒè¯

```java
// æ–‡ä»¶å¤§å°é™åˆ¶
private static final long MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB

// å…è®¸çš„æ–‡ä»¶ç±»å‹
private static final String[] ALLOWED_EXTENSIONS = {".jpg", ".jpeg", ".png", ".gif", ".webp"};
```

## ğŸ¯ æµ‹è¯•æ­¥éª¤

### 1. æµ‹è¯•å¤´åƒä¸Šä¼ 

1. ç™»å½•ç³»ç»Ÿ
2. è¿›å…¥ä¸ªäººä¸­å¿ƒï¼ˆ`/profile`ï¼‰
3. ç‚¹å‡»å¤´åƒ
4. é€‰æ‹©ä¸€å¼ å›¾ç‰‡ï¼ˆjpg/png/gif/webpï¼Œ< 5MBï¼‰
5. æŸ¥çœ‹ä¸Šä¼ è¿›åº¦
6. ç¡®è®¤å¤´åƒæ›´æ–°æˆåŠŸ

### 2. æµ‹è¯•å¤´åƒæ˜¾ç¤º

1. ä¸Šä¼ å¤´åƒå
2. æ£€æŸ¥ä¸ªäººä¸­å¿ƒé¡µé¢å¤´åƒæ˜¯å¦æ›´æ–°
3. æ£€æŸ¥å³ä¸Šè§’ç”¨æˆ·èœå•å¤´åƒæ˜¯å¦æ›´æ–°
4. åˆ·æ–°é¡µé¢ï¼Œå¤´åƒåº”è¯¥ä¿æŒ

### 3. æµ‹è¯•å¤´åƒæŒä¹…åŒ–

1. ä¸Šä¼ å¤´åƒ
2. é€€å‡ºç™»å½•
3. é‡æ–°ç™»å½•
4. å¤´åƒåº”è¯¥ä¾ç„¶å­˜åœ¨

### 4. æµ‹è¯•æ–‡ä»¶éªŒè¯

**æµ‹è¯•è¿‡å¤§æ–‡ä»¶ï¼š**
- é€‰æ‹© > 5MB çš„å›¾ç‰‡
- åº”è¯¥æ˜¾ç¤ºé”™è¯¯ï¼š`å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB`

**æµ‹è¯•éå›¾ç‰‡æ–‡ä»¶ï¼š**
- é€‰æ‹© .txtã€.pdf ç­‰æ–‡ä»¶
- åº”è¯¥æ˜¾ç¤ºé”™è¯¯ï¼š`åªæ”¯æŒ jpgã€pngã€gifã€webp æ ¼å¼çš„å›¾ç‰‡`

## ğŸ“¸ æ•ˆæœå±•ç¤º

### æœªä¸Šä¼ å¤´åƒ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        â”‚
â”‚   T    â”‚  <- æ˜¾ç¤ºé¦–å­—æ¯
â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å·²ä¸Šä¼ å¤´åƒ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        â”‚
â”‚  ğŸ“·   â”‚  <- æ˜¾ç¤ºçœŸå®å¤´åƒå›¾ç‰‡
â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é¼ æ ‡æ‚¬åœ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“·   â”‚
â”‚ æ›´æ¢  â”‚  <- æ˜¾ç¤ºä¸Šä¼ æç¤º
â”‚ å¤´åƒ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ–‡ä»¶å­˜å‚¨

- é»˜è®¤å­˜å‚¨åœ¨é¡¹ç›®çš„ `uploads/avatars/` ç›®å½•
- ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨OSSï¼ˆå¦‚é˜¿é‡Œäº‘OSSã€AWS S3ï¼‰
- éœ€è¦é…ç½®é™æ€èµ„æºè®¿é—®è·¯å¾„

### 2. å®‰å…¨æ€§

- âœ… æ–‡ä»¶ç±»å‹éªŒè¯
- âœ… æ–‡ä»¶å¤§å°é™åˆ¶
- âœ… æ–‡ä»¶åUUIDåŒ–ï¼ˆé˜²æ­¢è¦†ç›–ï¼‰
- âš ï¸ å»ºè®®æ·»åŠ ï¼šç—…æ¯’æ‰«æã€å†…å®¹æ£€æµ‹

### 3. æ€§èƒ½ä¼˜åŒ–

- è€ƒè™‘æ·»åŠ å›¾ç‰‡å‹ç¼©
- è€ƒè™‘ç”Ÿæˆç¼©ç•¥å›¾
- è€ƒè™‘ä½¿ç”¨CDNåŠ é€Ÿ

### 4. æ•°æ®åº“

ç¡®ä¿ `users` è¡¨æœ‰ `avatar_url` å­—æ®µï¼š
```sql
ALTER TABLE users ADD COLUMN avatar_url VARCHAR(255);
```

## ğŸ”œ æœªæ¥æ”¹è¿›

- [ ] æ”¯æŒå¤´åƒè£å‰ª
- [ ] æ”¯æŒæ‹–æ‹½ä¸Šä¼ 
- [ ] è‡ªåŠ¨å‹ç¼©å¤§å›¾ç‰‡
- [ ] ç”Ÿæˆå¤šç§å°ºå¯¸ç¼©ç•¥å›¾
- [ ] é›†æˆäº‘å­˜å‚¨ï¼ˆOSSï¼‰
- [ ] æ·»åŠ ä¸Šä¼ è¿›åº¦æ¡
- [ ] æ”¯æŒé»˜è®¤å¤´åƒé€‰æ‹©
- [ ] æ”¯æŒGravataré›†æˆ

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ä¸Šä¼ åå¤´åƒä¸æ˜¾ç¤º

**æ£€æŸ¥ï¼š**
1. åç«¯æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Ÿ
2. uploads/avatars ç›®å½•æ˜¯å¦å­˜åœ¨ï¼Ÿ
3. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ï¼Ÿ

**è§£å†³ï¼š**
- æ‰‹åŠ¨åˆ›å»º `uploads/avatars` ç›®å½•
- æ£€æŸ¥æ–‡ä»¶è·¯å¾„é…ç½®
- æŸ¥çœ‹åç«¯æ—¥å¿—

### Q2: ä¸Šä¼ æç¤ºå¤±è´¥

**æ£€æŸ¥ï¼š**
1. æ–‡ä»¶æ˜¯å¦è¶…è¿‡5MBï¼Ÿ
2. æ–‡ä»¶æ ¼å¼æ˜¯å¦æ”¯æŒï¼Ÿ
3. åç«¯æ˜¯å¦æœ‰æŠ¥é”™ï¼Ÿ

**è§£å†³ï¼š**
- ä½¿ç”¨ç¬¦åˆè¦æ±‚çš„å›¾ç‰‡
- æŸ¥çœ‹åç«¯æ—¥å¿—å®šä½é—®é¢˜

### Q3: å¤´åƒè·¯å¾„é”™è¯¯

**æ£€æŸ¥ï¼š**
- æ•°æ®åº“ä¸­çš„ `avatar_url` æ˜¯å¦æ­£ç¡®
- å‰ç«¯æ‹¼æ¥è·¯å¾„æ˜¯å¦æ­£ç¡®

**è§£å†³ï¼š**
```typescript
// æ­£ç¡®çš„è·¯å¾„æ‹¼æ¥
const fullUrl = user.avatarUrl.startsWith('http') 
  ? user.avatarUrl 
  : `http://localhost:8080${user.avatarUrl}`;
```

---

**ç°åœ¨å¯ä»¥ä¸Šä¼ å’Œæ˜¾ç¤ºå¤´åƒäº†ï¼** ğŸ“¸

